name: CI

on:
  push:
    branches:
      - protected
  pull_request:
    branches:
      - protected

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/protected' && github.event_name == 'push'
    concurrency: release
    permissions:
      # to grant the user triggering the CI permission to submit a new GitHub Release
      contents: read
    container:
      image: "ubuntu:latest"
      volumes:
        - "/home/runner/.ssh:/github/home/.ssh"
    steps:
      # a deploy key is needed because only the Admin users(or deploy keys) have permission to write to the protected
      # main branch if this CI is triggered by another user's PR, because the main branch is protected the CI won't be
      # able to push the auto-generated commits that python-semantic-release does
      - name: Checkout project
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: 'protected'
      - name: Provision ssh
        run: |
          apt-get update
          apt-get install openssh-client -y
      - name: Add SSH key for releasing
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: |
            ${{ secrets.SP_AUTO_DEPLOY_KEY_UNITY_YAML_PARSER_UNITY_YAML_PARSER }}
      - name: Python Semantic Release
        uses: sp-ricard-valverde/python-semantic-release@master
        with:
          github_token: "bla"
          repository_username: __token__
          repository_password: "blu"
