name: CI

on:
  push:
    branches:
      - protected
  pull_request:
    branches:
      - protected

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/protected' && github.event_name == 'push'
    concurrency: release
    permissions:
      # to grant the user triggering the CI permission to push a new Release
      contents: read
    steps:
      # a deploy key is needed because only the Admin users have permission to write to the protected main branch
      # if this CI is triggered by another user's PR, because the main branch is protected the CI won't be able to
      # push the auto-generated commits that python-semantic-release does
      - name: Install Python for semantic releases
        uses: actions/setup-python@v2
        with:
          python-version: '3.9.x'
      - name: Checkout project
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: 'protected'
      - name: Add SSH key for releasing
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: |
            ${{ secrets.WRONG_SSH_KEY }}
      # we cannot use python-semantic-release as a Github Action because it is executed inside a Docker image and
      # it does not work with the previous action, ssh-agent and we cannot use deploy keys
      - name: Run semantic releases
        env:
          GH_TOKEN: "bla"
          REPOSITORY_USERNAME: __token__
          REPOSITORY_PASSWORD: "blu"
        run: |
          cat ~/.ssh/known_hosts
          cat ~/.ssh/config
          git config -l
          cat /home/runner/.ssh/key-626c7d07e8d71d01abf3ba2b5cc61c15308cb0c7a51787b273a1e150216be335
          pip install -r requirements/publish.txt
          git config --global user.email "github@action.com"
          git config --global user.name "Github Action"
          semantic-release publish
